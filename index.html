<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Supernova - Full Restoration</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; cursor: crosshair; }
        canvas { display: block; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        
        #ui, #music-ui {
            position: absolute; color: #fff; font-family: 'Segoe UI', Tahoma, sans-serif;
            pointer-events: auto; text-transform: uppercase; letter-spacing: 1px; font-size: 10px;
            background: rgba(15, 15, 15, 0.9); padding: 18px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2); width: 240px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.8); user-select: none; z-index: 20; backdrop-filter: blur(4px);
        }
        #ui { top: 15px; left: 15px; }
        #music-ui { bottom: 15px; left: 15px; min-height: 185px; } 

        #stats-ui {
            position: absolute; top: 15px; right: 15px;
            color: #fff; font-family: 'Segoe UI', Tahoma, sans-serif;
            background: rgba(15, 15, 15, 0.9); padding: 12px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2); font-size: 10px; z-index: 30; text-align: right;
        }

        .music-header-top { margin-bottom: 10px; }
        .song-info-right { 
            color: #00ffcc; font-weight: bold; width: 100%; 
            white-space: normal; word-wrap: break-word; line-height: 1.4; margin-top: 5px; 
        }
        .time-display { color: #888; font-family: monospace; }

        /* Deceptive Slider Fix: No Dot, Not Clickable */
        #music-progress { 
            width: 100%; height: 4px; background: #333; border-radius: 2px; appearance: none; 
            pointer-events: none; margin-bottom: 15px; outline: none;
        }
        #music-progress::-webkit-slider-thumb { appearance: none; width: 0; height: 0; }
        #music-progress::-moz-range-thumb { width: 0; height: 0; border: 0; }

        .slider-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; color: #888; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00ffcc; background: #333; height: 4px; border-radius: 2px; }
        .val { float: right; color: #00ffcc; font-family: monospace; text-decoration: underline; }
        
        #vol-meter { height: 2px; background: #333; margin-top: 5px; width: 100%; position: relative; }
        #vol-bar { height: 100%; background: #ff00ff; width: 0%; transition: width 0.1s; }
        
        .btn-container { display: flex; gap: 5px; margin-top: 10px; }
        button {
            flex: 1; background: #222; color: #fff; border: 1px solid #444;
            padding: 8px; border-radius: 4px; font-size: 9px; cursor: pointer; text-transform: uppercase; transition: 0.2s;
        }
        button.active { background: #00ffcc; color: #000; }
        button.cymatic-active { background: #ff00ff; color: #fff; border-color: #ff00ff; }
        
        .color-pickers { display: flex; gap: 5px; margin-top: 5px; }
        input[type=color] { width: 100%; height: 24px; border: 1px solid #444; background: none; cursor: pointer; }
        #yt-player { display: none; }
    </style>
</head>
<body>

    <div id="stats-ui">
        <div id="fpsCounter">FPS: 0</div>
        <button id="toggle-gui-btn" style="background:none; border:1px solid #444; color:#666; font-size:8px; margin-top:5px; width:100%;">HIDE UI</button>
    </div>
    
    <div id="ui">
        <div id="statusText" style="margin-bottom:10px; font-weight:bold; color:#00ffcc;">SYSTEM READY</div>
        <div class="slider-group"><label>Particles <span id="pCount" class="val">50,000</span></label><input type="range" id="pSlider" min="1000" max="1500000" step="1000" value="50000"></div>
        <div class="slider-group"><label>Explosion Force <span id="ePower" class="val">1200</span></label><input type="range" id="eSlider" min="50" max="5000" step="50" value="1200"></div>
        <div class="slider-group"><label>Drift <span id="fVal" class="val">3.0</span></label><input type="range" id="fSlider" min="1" max="5" step="0.1" value="3.0"></div>
        <div class="slider-group"><label>Spiral Speed <span id="sVal" class="val">1.6</span></label><input type="range" id="sSlider" min="0.1" max="5" step="0.1" value="1.6"></div>
        
        <div class="slider-group">
            <label>Colors</label>
            <div class="color-pickers">
                <input type="color" id="c1" value="#ffffff">
                <input type="color" id="c2" value="#888888">
                <input type="color" id="c3" value="#00f2ff">
            </div>
        </div>

        <div class="btn-container"><button id="btnWebGL" class="active">WebGL</button><button id="btnCanvas">Canvas 2D</button></div>
        <button id="bhBtn" style="margin-top: 5px; width: 100%;">BLACK HOLE: OFF</button>
        <button id="cymaticBtn" style="margin-top: 5px; width: 100%;">CYMATIC MODE: OFF</button>
    </div>

    <div id="music-ui">
        <div class="music-header-top">
            <div class="time-display"><span id="cur-time">0</span>s - <span id="total-time">0</span>s</div>
            <div id="song-name-top" class="song-info-right">INITIALIZING...</div>
        </div>
        <input type="range" id="music-progress" value="0">
        
        <div class="slider-group">
            <label>Master Volume <span id="mVolVal" class="val">50%</span></label>
            <input type="range" id="music-vol-control" min="0" max="100" value="50">
        </div>

        <div style="margin-bottom: 10px;">
            <label>Beat Sensitivity</label>
            <div id="vol-meter"><div id="vol-bar"></div></div>
        </div>
        <div class="btn-container"><button id="play-pause-btn">WAIT...</button><button id="next-track-btn">NEXT TRACK</button></div>
    </div>

    <div id="yt-player"></div>
    <canvas id="glCanvas"></canvas>
    <canvas id="c2dCanvas" style="display:none;"></canvas>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- CORE STATE ---
        let mode = 'webgl', count = 50000, explosionStrength = 1200, driftFactor = 3.0, swirlForce = 1.6;
        let blackHoleActive = false, cymaticActive = false, lastExplosionTime = 0;
        let isMusicPlaying = false, smoothedVol = 0;
        const cooldownMs = 1200, mouse = { x: 0, y: 0, isDown: false, wasDown: false, glX: 0, glY: 0 };
        let cPos = { x: 0, y: 0, vx: 0, vy: 0 }, moveTimer = 0;

        // --- YOUTUBE API ---
        let player;
        const trackList = ['jCEZOqPqhLs', 'jd6dPtN9E9g', 'L_UBFnwaOgY', 'hraj31Bc5Gc', '76r8I6OPQ8I'];
        let currentTrackIdx = 0;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '0', width: '0', videoId: trackList[currentTrackIdx],
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady() {
            document.getElementById('play-pause-btn').innerText = "PLAY";
            player.setVolume(50);
            setInterval(() => {
                if(player && player.getPlayerState() === 1) {
                    const cur = player.getCurrentTime(), dur = player.getDuration();
                    document.getElementById('cur-time').innerText = Math.floor(cur);
                    document.getElementById('total-time').innerText = Math.floor(dur);
                    document.getElementById('music-progress').value = (cur / dur) * 100;
                    document.getElementById('song-name-top').innerText = player.getVideoData().title;
                }
            }, 500);
        }

        function onPlayerStateChange(e) {
            isMusicPlaying = (e.data === 1);
            document.getElementById('play-pause-btn').innerText = isMusicPlaying ? "PAUSE" : "PLAY";
        }

        document.getElementById('music-vol-control').oninput = function() {
            if(player) player.setVolume(this.value);
            document.getElementById('mVolVal').innerText = this.value + "%";
        };

        document.getElementById('play-pause-btn').onclick = () => isMusicPlaying ? player.pauseVideo() : player.playVideo();
        document.getElementById('next-track-btn').onclick = () => { 
            currentTrackIdx = (currentTrackIdx + 1) % trackList.length; 
            player.loadVideoById(trackList[currentTrackIdx]); 
        };

        // --- ENGINE SETUP ---
        const glCanvas = document.getElementById('glCanvas'), c2dCanvas = document.getElementById('c2dCanvas');
        const gl = glCanvas.getContext('webgl', { alpha: false });
        const ctx = c2dCanvas.getContext('2d', { alpha: false });

        const MAX_P = 1500000;
        const posArr = new Float32Array(MAX_P * 2), velArr = new Float32Array(MAX_P * 2), 
              colArr = new Float32Array(MAX_P * 3), speedArr = new Float32Array(MAX_P), sizeArr = new Float32Array(MAX_P);

        function hexToRgb(h) { return [parseInt(h.slice(1,3),16)/255, parseInt(h.slice(3,5),16)/255, parseInt(h.slice(5,7),16)/255]; }
        function updateColors() {
            const c = [hexToRgb(document.getElementById('c1').value), hexToRgb(document.getElementById('c2').value), hexToRgb(document.getElementById('c3').value)];
            for (let i = 0; i < MAX_P; i++) {
                let r = Math.random(), sel = r < 0.8 ? c[0] : (r < 0.9 ? c[1] : c[2]);
                colArr[i*3] = sel[0]; colArr[i*3+1] = sel[1]; colArr[i*3+2] = sel[2];
            }
        }

        function resize() {
            glCanvas.width = c2dCanvas.width = window.innerWidth;
            glCanvas.height = c2dCanvas.height = window.innerHeight;
            if(gl) gl.viewport(0, 0, glCanvas.width, glCanvas.height);
        }
        window.onresize = resize;
        window.onmousemove = e => {
            mouse.x = e.clientX; mouse.y = e.clientY;
            mouse.glX = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.glY = (e.clientY / window.innerHeight) * -2 + 1;
        };
        window.onmousedown = (e) => { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') mouse.isDown = true; };
        window.onmouseup = () => mouse.isDown = false;

        // --- SHADERS ---
        const vs = `attribute vec2 a_p; attribute vec3 a_c; attribute float a_s; varying vec3 v_c; varying vec2 v_n; void main(){ gl_Position=vec4(a_p,0,1); gl_PointSize=a_s; v_c=a_c; v_n=a_p; }`;
        const fs = `precision mediump float; varying vec3 v_c; varying vec2 v_n; void main(){ float a = 1.0 - max(smoothstep(0.95,1.0,abs(v_n.x)), smoothstep(0.95,1.0,abs(v_n.y))); gl_FragColor=vec4(v_c, a); }`;
        const prg = gl.createProgram();
        const createS = (t, s) => { const sh = gl.createShader(t); gl.shaderSource(sh, s); gl.compileShader(sh); gl.attachShader(prg, sh); };
        createS(gl.VERTEX_SHADER, vs); createS(gl.FRAGMENT_SHADER, fs);
        gl.linkProgram(prg); gl.useProgram(prg);
        gl.enable(gl.BLEND); gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

        for(let i=0; i<MAX_P; i++) {
            posArr[i*2]=Math.random()*2-1; posArr[i*2+1]=Math.random()*2-1;
            speedArr[i]=0.006+Math.random()*0.01; sizeArr[i]=1.5+Math.random();
        }
        updateColors();

        const pBuf = gl.createBuffer(), cBuf = gl.createBuffer(), sBuf = gl.createBuffer();
        let lastTime = 0, frames = 0, fpsT = 0;

        function animate(now) {
            const dt = (now - lastTime) / 16.667; lastTime = now; frames++;
            if(now > fpsT+1000) { document.getElementById('fpsCounter').innerText = `FPS: ${frames}`; frames=0; fpsT=now; }

            // Smoothed Audio Logic
            if (isMusicPlaying) {
                const raw = (Math.sin(now/120)*0.4 + 0.4) + (Math.random()*0.2);
                smoothedVol += (raw - smoothedVol) * 0.1; 
            } else { smoothedVol *= 0.9; }
            document.getElementById('vol-bar').style.width = (smoothedVol * 100) + "%";

            let tx = mouse.glX, ty = mouse.glY, active = mouse.isDown;

            if(cymaticActive && isMusicPlaying) {
                moveTimer -= dt;
                if(moveTimer <= 0) {
                    const a = Math.random()*Math.PI*2;
                    cPos.vx = Math.cos(a)*0.005; cPos.vy = Math.sin(a)*0.005;
                    moveTimer = 200 + Math.random()*50;
                }
                cPos.x += cPos.vx * dt; cPos.y += cPos.vy * dt;
                if(Math.abs(cPos.x)>1) cPos.x=0; if(Math.abs(cPos.y)>1) cPos.y=0;
                tx = cPos.x; ty = cPos.y; active = true;
            }

            const isCool = (Date.now() - lastExplosionTime) < cooldownMs;
            const released = mouse.wasDown && !mouse.isDown && !isCool && !cymaticActive;
            if(released) lastExplosionTime = Date.now();

            // Run Engines
            mode === 'webgl' ? runWebGL(dt, released, tx, ty, active) : runCanvas(dt, released, tx, ty, active);
            
            mouse.wasDown = mouse.isDown;
            requestAnimationFrame(animate);
        }

        function runWebGL(dt, released, tx, ty, active) {
            const friction = Math.pow(0.82 + (driftFactor/5)*0.17, dt);
            for(let i=0; i<count; i++) {
                const i2 = i*2;
                let dx = tx - posArr[i2], dy = ty - posArr[i2+1], d = Math.sqrt(dx*dx+dy*dy)||0.001;
                if(active) {
                    const sx = -dy/d, sy = dx/d;
                    velArr[i2] += (dx * speedArr[i] * dt) + (sx * swirlForce * 0.02 * dt);
                    velArr[i2+1] += (dy * speedArr[i] * dt) + (sy * swirlForce * 0.02 * dt);
                    velArr[i2] *= Math.pow(0.88, dt); velArr[i2+1] *= Math.pow(0.88, dt);
                } else if(released) {
                    const f = (1.0/d) * (explosionStrength/40000);
                    velArr[i2] = (-dx/d)*f*(Math.random()*2+0.5); velArr[i2+1] = (-dy/d)*f*(Math.random()*2+0.5);
                } else {
                    velArr[i2] *= friction; velArr[i2+1] *= friction;
                    if(blackHoleActive) { velArr[i2] += (dx/d)*0.002*dt; velArr[i2+1] += (dy/d)*0.002*dt; }
                }
                posArr[i2] += velArr[i2]*dt; posArr[i2+1] += velArr[i2+1]*dt;
                if(posArr[i2]>1) posArr[i2]=-1; else if(posArr[i2]<-1) posArr[i2]=1;
                if(posArr[i2+1]>1) posArr[i2+1]=-1; else if(posArr[i2+1]<-1) posArr[i2+1]=1;
            }
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.bindBuffer(gl.ARRAY_BUFFER, pBuf); gl.bufferData(gl.ARRAY_BUFFER, posArr.subarray(0, count*2), gl.DYNAMIC_DRAW);
            const pLoc = gl.getAttribLocation(prg, 'a_p'); gl.enableVertexAttribArray(pLoc); gl.vertexAttribPointer(pLoc, 2, gl.FLOAT, false, 0, 0);
            gl.bindBuffer(gl.ARRAY_BUFFER, cBuf); gl.bufferData(gl.ARRAY_BUFFER, colArr.subarray(0, count*3), gl.DYNAMIC_DRAW);
            const cLoc = gl.getAttribLocation(prg, 'a_c'); gl.enableVertexAttribArray(cLoc); gl.vertexAttribPointer(cLoc, 3, gl.FLOAT, false, 0, 0);
            gl.bindBuffer(gl.ARRAY_BUFFER, sBuf); gl.bufferData(gl.ARRAY_BUFFER, sizeArr.subarray(0, count), gl.STATIC_DRAW);
            const sLoc = gl.getAttribLocation(prg, 'a_s'); gl.enableVertexAttribArray(sLoc); gl.vertexAttribPointer(sLoc, 1, gl.FLOAT, false, 0, 0);
            gl.drawArrays(gl.POINTS, 0, count);
        }

        function runCanvas(dt, released, tx, ty, active) {
            ctx.fillStyle = 'rgba(0,0,0,0.25)'; ctx.fillRect(0,0,c2dCanvas.width,c2dCanvas.height);
            const friction = Math.pow(0.82 + (driftFactor/5)*0.17, dt);
            const w = c2dCanvas.width, h = c2dCanvas.height, hW = w/2, hH = h/2;
            const colors = [document.getElementById('c1').value, document.getElementById('c2').value, document.getElementById('c3').value];
            
            const targetX = (tx + 1) * hW, targetY = (1 - (ty + 1) * 0.5) * h;
            const safeCount = Math.min(count, 150000);

            for(let i=0; i<safeCount; i++) {
                const i2 = i*2;
                let px = (posArr[i2]+1)*hW, py = (1-(posArr[i2+1]+1)*0.5)*h;
                let vx = velArr[i2]*hW, vy = -velArr[i2+1]*hH;
                let dx = targetX - px, dy = targetY - py, dist = Math.sqrt(dx*dx+dy*dy)||1;

                if(active) {
                    vx += (dx * speedArr[i] + (-dy/dist) * swirlForce) * dt;
                    vy += (dy * speedArr[i] + (dx/dist) * swirlForce) * dt;
                    vx *= Math.pow(0.88, dt); vy *= Math.pow(0.88, dt);
                } else if(released) {
                    const f = (1/dist)*explosionStrength*(Math.random()*2+0.5);
                    vx = (-dx/dist)*f; vy = (-dy/dist)*f;
                } else {
                    vx *= friction; vy *= friction;
                    if(blackHoleActive) { vx += (dx/dist)*0.5*dt; vy += (dy/dist)*0.5*dt; }
                }
                px += vx*dt; py += vy*dt;
                if(px<0) px=w; else if(px>w) px=0; if(py<0) py=h; else if(py>h) py=0;
                
                posArr[i2] = (px/hW)-1; posArr[i2+1] = ((h-py)/hH)-1;
                velArr[i2] = vx/hW; velArr[i2+1] = -vy/hH;

                const edgeX = Math.abs(posArr[i2]), edgeY = Math.abs(posArr[i2+1]);
                let alpha = 1.0 - max(smoothstep(0.95, 1.0, edgeX), smoothstep(0.95, 1.0, edgeY));
                
                if(alpha > 0.1) {
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = colors[i%3];
                    ctx.fillRect(px, py, sizeArr[i], sizeArr[i]);
                }
            }
            ctx.globalAlpha = 1.0;
        }

        // --- HELPERS ---
        function smoothstep(e0, e1, x) { let t = clamp((x - e0) / (e1 - e0), 0, 1); return t * t * (3 - 2 * t); }
        function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }
        function max(a, b) { return a > b ? a : b; }

        // --- BINDINGS ---
        document.getElementById('pSlider').oninput = function() { count = parseInt(this.value); document.getElementById('pCount').innerText = count.toLocaleString(); };
        document.getElementById('fSlider').oninput = function() { driftFactor = parseFloat(this.value); document.getElementById('fVal').innerText = driftFactor; };
        document.getElementById('eSlider').oninput = function() { explosionStrength = parseFloat(this.value); document.getElementById('ePower').innerText = explosionStrength; };
        document.getElementById('sSlider').oninput = function() { swirlForce = parseFloat(this.value); document.getElementById('sVal').innerText = swirlForce; };
        document.getElementById('c1').oninput = updateColors; document.getElementById('c2').oninput = updateColors; document.getElementById('c3').oninput = updateColors;
        document.getElementById('cymaticBtn').onclick = function() { cymaticActive = !cymaticActive; this.classList.toggle('cymatic-active'); this.innerText = `CYMATIC MODE: ${cymaticActive ? 'ON' : 'OFF'}`; };
        document.getElementById('bhBtn').onclick = function() { blackHoleActive = !blackHoleActive; this.classList.toggle('active'); this.innerText = `BLACK HOLE: ${blackHoleActive ? 'ON' : 'OFF'}`; };
        document.getElementById('btnWebGL').onclick = function() { mode = 'webgl'; glCanvas.style.display = 'block'; c2dCanvas.style.display = 'none'; this.classList.add('active'); document.getElementById('btnCanvas').classList.remove('active'); };
        document.getElementById('btnCanvas').onclick = function() { mode = 'canvas'; glCanvas.style.display = 'none'; c2dCanvas.style.display = 'block'; this.classList.add('active'); document.getElementById('btnWebGL').classList.remove('active'); };
        document.getElementById('toggle-gui-btn').onclick = () => { document.getElementById('ui').style.display = document.getElementById('ui').style.display === 'none' ? 'block' : 'none'; document.getElementById('music-ui').style.display = document.getElementById('music-ui').style.display === 'none' ? 'block' : 'none'; };

        resize();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
